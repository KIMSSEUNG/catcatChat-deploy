#!/usr/bin/env bash
set -euo pipefail

# â”€â”€ [ì…ë ¥ ì¸ì: ì™¸ë¶€ ë ˆí¬ì˜ ì»¤ë°‹ SHA (7ìë¦¬)] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SHA="${1:-}"
if [[ -z "${SHA}" ]]; then
  echo "âŒ ì‚¬ìš©ë²•: $0 <BE_SHA>"
  exit 1
fi

# â”€â”€ [ê²½ë¡œ/ì´ë¦„ ì„¤ì •] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
APP_NAME="catcatChat"
APP_DIR="/home/ubuntu/catcatChat"
RELEASES_DIR="$APP_DIR/releases"

UPLOADED_JAR="$APP_DIR/${APP_NAME}-${SHA}.jar"   # ì›Œí¬í”Œë¡œìš°ê°€ ì—…ë¡œë“œí•œ íŒŒì¼
TARGET_JAR="$RELEASES_DIR/${APP_NAME}-${SHA}.jar" # releasesë¡œ ì´ë™ì‹œí‚¬ ìµœì¢… ìœ„ì¹˜
CURRENT_LINK="$APP_DIR/${APP_NAME}.jar"           # í•­ìƒ ì´ ê²½ë¡œë¡œ ì‹¤í–‰(ì‹¬ë³¼ë¦­ ë§í¬)

LOG_FILE="$APP_DIR/server.log"
TZ_OPT="-Duser.timezone=Asia/Seoul"

mkdir -p "$RELEASES_DIR"

# â”€â”€ [ì—…ë¡œë“œëœ JAR í™•ì¸ ë° ì´ë™] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ ! -f "$UPLOADED_JAR" ]]; then
  echo "âŒ ì—…ë¡œë“œëœ JARê°€ ì—†ìŒ: $UPLOADED_JAR"
  exit 1
fi

echo "ğŸ“¦ ë¦´ë¦¬ì¦ˆ ë””ë ‰í† ë¦¬ë¡œ ì´ë™: $UPLOADED_JAR â†’ $TARGET_JAR"
mv -f "$UPLOADED_JAR" "$TARGET_JAR"

# â”€â”€ [ì‹¬ë³¼ë¦­ ë§í¬ ê°±ì‹ ] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ”— í˜„ì¬ ì‹¤í–‰ ë§í¬ ê°±ì‹ : $CURRENT_LINK â†’ $TARGET_JAR"
ln -sfn "$TARGET_JAR" "$CURRENT_LINK"
echo "â„¹ï¸ ë§í¬ í™•ì¸: $(ls -l "$CURRENT_LINK")"

# â”€â”€ [ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ›‘ ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ ì¤‘..."
# current ë§í¬ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¡ëŠ” ê²ƒì´ ê°€ì¥ ì•ˆì „
PID=$(pgrep -f "java.*${CURRENT_LINK}" || true)
if [[ -n "${PID}" ]]; then
  echo "â†’ ì‹¤í–‰ ì¤‘ì¸ PID: ${PID}"
  kill -9 ${PID}
  echo "âœ… í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì™„ë£Œ"
else
  echo "â„¹ï¸ ì‹¤í–‰ ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì—†ìŒ"
fi

# â”€â”€ [ë¡œê·¸ í—¤ë” ë‚¨ê¸°ê¸°] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{
  echo
  echo "ğŸš€ [$(date '+%Y-%m-%d %H:%M:%S')] ìƒˆ ë²„ì „ ë°°í¬ ë° ì‹¤í–‰ ì‹œì‘"
  echo "    - SHA: ${SHA}"
  echo "    - Target: ${TARGET_JAR}"
} >> "$LOG_FILE"

# â”€â”€ [ìƒˆ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸš€ ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì¤‘..."
# ë¡œê·¸ë¥¼ ë®ì–´ì“°ì§€ ì•Šë„ë¡ >> ì‚¬ìš©(ì¶”ê°€ ê¸°ë¡)
nohup java $TZ_OPT -jar "$CURRENT_LINK" >> "$LOG_FILE" 2>&1 &

NEW_PID=$!
echo "âœ… ìƒˆ PID: $NEW_PID"
echo "âœ… ì‹œì‘ ì»¤ë§¨ë“œ: java $TZ_OPT -jar $CURRENT_LINK"
echo "âœ… ì‹¤íŒŒì¼: $(readlink -f "$CURRENT_LINK")"
